create table userInfo
(
    id serial PRIMARY KEY,
    login character varing(20) UNIQUE NOT NULL,
    password character varing(10) NOT NULL CHECK(char_length > 6),
    timeReg timestamp without time zone NOT NULL DEFAULT (current_timestamp AT TIME ZONE 'UTC'),
    mac macaddr NOT NULL
);

create unique index u_log on userInfo (login)


create table loginExitCollapse
(
    event character varing(8) CHECK(IN('login', 'exit', 'collapse')),
    time timestamp without time zone NOT NULL,
    id integer NOT NULL,
    FOREIGN KEY (id)
        REFERENCES userInfo(id)
);

create index lec_id on loginExitCollapse (id)


create table tools
(
    toolUsed chatacter(5) CHECK(IN('tool1', 'tool2', 'tool3', 'tool4')),
    timestart timestamp without time zone DEFAULT(NULL),
    timeclose timestamp without time zone DEFAULT(NULL),
    id integer NOT NULL,
    FOREIGN KEY (id)
        REFERENCES userInfo(id)
)

create index t_id on tools (id)


create table advertisers
(
    contract_no character varing(40) PRIMARY KEY,
    name character varing(30) NOT NULL,
    contract_sign timestamp without time zone NOT NULL,
    contract_term timestamp without time zone,
    GMT_offset smallint DEFAULT(0)
)


create table advertising 
(
    advertiser_name char varing NOT NULL,
    id integer NOT NULL,
    time_start timestamp without time zone NOT NULL,
    time_close timestamp without time zone DEFAULT(0),
    time_view GENERATED ALWAYS AS (timeclose - timestart) STORED,
    FOREIGN KEY (advertiser_name)
        REFERENCES advertiser(name)
    FOREIGN KEY (id)
        REFERENCES userInfo(id)
)

create index adv_id on advertising(id)


create recursive view device_adv_stat as
    select id, sum(case time_view > 0 then time_view end)
    from advertising
    group by id

create index adv_stat_id on device_adv_stat(id)


create recursive view device_tools_stat as
    select id, count(case toolUsed is like('tool1') then 1 end), count(case toolUsed is like('tool2') then 1 end), count(case toolUsed is like('tool3') then 1 end), count(case toolUsed is like('tool4') then 1 end)
    from tools
    group by id

create index dev_t_id on device_tools_stat(id)